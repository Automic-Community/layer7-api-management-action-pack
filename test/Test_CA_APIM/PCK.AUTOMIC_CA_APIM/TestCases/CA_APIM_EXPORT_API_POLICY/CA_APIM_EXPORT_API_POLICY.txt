*** Settings ***
Suite Setup       Startup
Suite Teardown    Teardown
Force Tags        CA_APIM_EXPORT_API_POLICY
Test Template     Export API Policy Job Template
Library           com.automic.robot.itpa.ItpaLibrary
Library           String
Library           DateTime
Resource          ../../Resources/messages.txt
Resource          ../../Resources/keywords.txt
Resource          ../../Resources/variables.txt
Resource          ../../Resources/actions.txt

*** Test Cases ***    OK_NOK    ID                ExportPath       ExportType       MapBy       L7Key       RequestFolder       ExportGateway       Dependencies       EncryptSecrets       EncryptCluster       OnlyService        OnlyDependencies
Export API Policy with all valid data
                      [Tags]    main_scenarios
                      OK        ${ID}             ${ExportPath}    ${ExportType}    ${MapBy}    ${L7Key}    ${RequestFolder}    ${ExportGateway}    ${Dependencies}    ${EncryptSecrets}    ${EncryptCluster}    ${OnlyService}     ${OnlyDependencies}

Export API Policy with invalid ID
                      NOK       Invalid           ${ExportPath}    ${ExportType}    ${MapBy}    ${L7Key}    ${RequestFolder}    ${ExportGateway}    ${Dependencies}    ${EncryptSecrets}    ${EncryptCluster}    ${OnlyService}     ${OnlyDependencies}

Export API Policy with invalid ExportPath
                      NOK       ${ID}             ${ExportPath}    Invalid          ${MapBy}    ${L7Key}    ${RequestFolder}    ${ExportGateway}    ${Dependencies}    ${EncryptSecrets}    ${EncryptCluster}    ${OnlyService}     ${OnlyDependencies}

Export API Policy with invalid MapBy
                      NOK       ${ID}             ${ExportPath}    ${ExportType}    Invalid     ${L7Key}    ${RequestFolder}    ${ExportGateway}    ${Dependencies}    ${EncryptSecrets}    ${EncryptCluster}    ${OnlyService1}    ${OnlyDependencies}

Export API Policy with Yes in OnlyService
                      [Tags]    main_scenarios
                      OK        ${ID}             ${ExportPath}    ${ExportType}    ${MapBy}    ${L7Key}    ${RequestFolder}    ${ExportGateway}    ${Dependencies}    ${EncryptSecrets}    ${EncryptCluster}    ${OnlyService}     ${OnlyDependencies1}

Export API Policy with Yes in OnlyDependencies
                      [Tags]    main_scenarios
                      OK        ${ID}             ${ExportPath}    ${ExportType}    ${MapBy}    ${L7Key}    ${RequestFolder}    ${ExportGateway}    ${Dependencies}    ${EncryptSecrets}    ${EncryptCluster}    ${OnlyService1}    ${OnlyDependencies1}

Export API Policy with Yes in both OnlyService and OnlyDependencies
                      [Tags]    main_scenarios
                      NOK       ${ID}             ${ExportPath}    ${ExportType}    ${MapBy}    ${L7Key}    ${RequestFolder}    ${ExportGateway}    ${Dependencies}    ${EncryptSecrets}    ${EncryptCluster}    ${OnlyService}     ${OnlyDependencies}

*** Keywords ***
Startup
    Log    *******Start Test "Export API PolicyJOB"*******
    Log    *******Connect to AE*******
    Connect AE

Export API Policy Job Template
    [Arguments]    ${OK_NOK}    ${ID}    ${ExportPath}    ${ExportType}    ${MapBy}    ${L7Key}
    ...    ${RequestFolder}    ${ExportGateway}    ${Dependencies}    ${EncryptSecrets}    ${EncryptCluster}    ${OnlyService}
    ...    ${OnlyDependencies}
    [Documentation]    This test tests the feature of Export API Policy.
    ...    -${OK_NOK}: Boolean value indicate if the action is ENDED_OK or ENDED_NOT_OK. Value of this variable should be OK or NOK.
    ...    -${ID}: This field specifies policy ID to be exported.
    ...    -${ExportPath}: This field specifies job name of CA7 job.
    ...    -${ExportType}: This field specifies the type of bundling for given Policy export.
    ...    -${MapBy}: This field specifies the default mapping for given Policy export.
    ...    -${L7Key}: This field specifies the Provide base64 encoded passphrase to use for the encryption key when encrypting secrets.
    ...    -${RequestFolder}: This field specifies whether to include the folder in the bundle or just it's contents.
    ...    -${ExportGateway}: This field specifies whether if Gateway Rest Management Service is also exported.
    ...    -${Dependencies}: This field specifies whether if dependencies are also included.
    ...    -${EncryptSecrets}: This field specifies whether if secret values are encrypted.
    ...    -${EncryptCluster}: This field specifies whether if Cluster Passphrase is used for encrypting secrets.
    ...    -${OnlyService}: This field specifies whether if only service policy is included in the export.
    ...    -${OnlyDependencies}: This field specifies if only dependencies are included in the export.
    Generate String
    Init Action    ${_CA_APIM_ACTION}
    Connect To CA_APIM
    Run Keyword If    '${ID}' == 'Invalid'    Action Set    &UC4RB_APIM_POLICY_ID#    ${Generated_Name}_${Time}
    ...    ELSE    Action Set    &UC4RB_APIM_POLICY_ID#    ${ID}
    Run Keyword If    '${ExportPath}' == 'Invalid'    Action Set    &UC4RB_APIM_EXPORT_PATH#    ${Generated_Name}_${Time}
    ...    ELSE    Action Set    &UC4RB_APIM_EXPORT_PATH#    ${ExportPath}
    Run Keyword If    '${ExportType}' == 'Invalid'    Action Set    &UC4RB_APIM_EXPORT_TYPE#    ${Generated_Name}_${Time}
    ...    ELSE    Action Set    &UC4RB_APIM_EXPORT_TYPE#    ${ExportType}
    Run Keyword If    '${MapBy}' == 'Invalid'    Action Set    &UC4RB_APIM_MAP_BY#    ${Generated_Name}_${Time}
    ...    ELSE    Action Set    &UC4RB_APIM_MAP_BY#    ${MapBy}
    Action Set    &UC4RB_APIM_L7_KEY_PASSPHRASE#    ${L7Key}
    Action Set    &UC4RB_APIM_INC_REQ_FOLDER#    ${RequestFolder}
    Action Set    &UC4RB_APIM_EXPORT_GATEWAY_RMS#    ${ExportGateway}
    Action Set    &UC4RB_APIM_INC_DEPENDENCIES#    ${Dependencies}
    Action Set    &UC4RB_APIM_ENCRYPT_SECRETS#    ${EncryptSecrets}
    Action Set    &UC4RB_APIM_ENC_CLUSTER#    ${EncryptCluster}
    Action Set    &UC4RB_APIM_ONLY_SERVICE_POLICY#    ${OnlyService}
    Action Set    &UC4RB_APIM_ONLY_DEPENDENCIES#    ${OnlyDependencies}
    Action Execute
    Run Keyword If    '${OK_NOK}' == 'OK'    Assert Success
    ...    ELSE    Assert Failure

Teardown
    Log    *******End Test "Export API Policy"*******
